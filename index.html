<!DOCTYPE html>
<html lang="en">
<head>

<style>
  
</style>

</head>

<body>
  <div id="emulator"></div>
  
  <div>
    <canvas id="canvas" width="256" height="256"></canvas>
    <br>
    <label class="lab">Speed</label>&nbsp
    <output class="lab" id="RS_LAB">2</output>
    <input name="REPLAY_SPEED" id="REPLAY_SPEED" type="range" min="0.02" 
       max="5" step=".01" value="2" onchange="ReplaySpeedChange()"/>
    <br>
    <button onclick="SaveData()" type="button">SaveData</button>
    <button onclick="LoadData()" type="button">LoadData</button>
  </div>

  <script src="lib/jquery-1.4.2.min.js"></script>
  <script src="jsnes_src/nes.js"></script>
  <script src="jsnes_src/utils.js"></script>
  <script src="jsnes_src/cpu.js"></script>
  <script src="jsnes_src/keyboard.js"></script>
  <script src="jsnes_src/mappers.js"></script>
  <script src="jsnes_src/papu.js"></script>
  <script src="jsnes_src/ppu.js"></script>
  <script src="jsnes_src/rom.js"></script>
  <script src="jsnes_src/ui.js"></script>
  <script src="src/util.js"></script>
  <script src="src/GameAutoMaker.js"></script>
     
  <script>

var PIX_TOL = 1,
    MOV_TOL = 5;
  
var fps, last_date, second = 0, frame_count = 0, replay_speed = 1;

var canvas = document.getElementById('canvas');

var nes = new JSNES({
  'ui': $('#emulator').JSNESUI({
    "Roms": [
      'Blaster Master.nes',
      'Bomberman.nes',
      'Bubble Bobble.nes',
      'Castlevania.nes',
      'Contra.nes',
      'Donkey Kong.nes',
      'Final Fantasy.nes',
      'Legend of Zelda, The.nes',
      'Mario Bros..nes',
      'Mega Man.nes',
      'Pac Man (Namco).nes',
      'Super Mario Bros. 2.nes',
      'Super Mario Bros. 3.nes',
      'Super Mario Bros..nes',
      'Super Pitfall.nes',
      'Tetris (Nintendo).nes'
    ]
  })
});

var gam = new GameAutoMaker(nes.frames);

window.requestAnimationFrame(Draw);

function Draw() {
  frame_count += replay_speed * 2;
  if (frame_count >= gam.footage.length - replay_speed) {
    frame_count = 1;
    if (nes.frames.length > 0) {
      gam = new GameAutoMaker(nes.frames, PIX_TOL, MOV_TOL);
    }
  }
  
  gam.ProcessFrame(Math.floor(frame_count));
  
  var ctx = canvas.getContext('2d');
  
  ctx.clearRect(0, 0, 256, 256);
  ctx.fillStyle = "#000000";
  ctx.fillRect(0, 0, 256, 256);
  
  for (var i = 0; i < gam.sprite_groups.length; i++) {
    ctx.fillStyle = gam.sprite_groups[i].color;
    for (var j = 0; j < gam.sprite_groups[i].s.length; j++) {
      ctx.fillRect(gam.sprite_groups[i].s[j].pos.x,
                   gam.sprite_groups[i].s[j].pos.y,
                   gam.sprite_groups[i].s[j].size,
                   gam.sprite_groups[i].s[j].size);
      
    }
  }
  window.requestAnimationFrame(Draw);
}

function SaveData() {
  localStorage.setItem('frame_data', JSON.stringify(gam.footage));
}

function LoadData() {
  var frame_data = localStorage.getItem('frame_data');
  if (frame_data != "") {
    gam.footage = JSON.parse(frame_data);
  }
}

function ReplaySpeedChange() {
  replay_speed = Number(document.querySelector('#REPLAY_SPEED').value);
  document.querySelector('#RS_LAB').value = replay_speed;
}

  </script>
  <!--[if IE]>
    <script type="text/vbscript" src="source/jsnes-ie-hacks.vbscript"></script>
  <![endif]-->

</body>
</html>
